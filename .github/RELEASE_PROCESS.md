# Automated Release Process

This document explains how the automated release system works for GitOps Reverser.

## Overview

GitOps Reverser uses **semantic versioning** with **automated releases** based on [Conventional Commits](https://www.conventionalcommits.org/). Everything is handled by a single unified CI workflow that runs tests, creates releases, and publishes Docker images.

Every push to the `main` branch can potentially trigger a new release, but only if:

1. All CI tests pass (lint, unit tests, e2e tests)
2. Commits follow the conventional commit format
3. The Release PR is merged

## How It Works

### 1. Push to Main

When code is pushed to the `main` branch:

```bash
git commit -m "feat(controller): add support for multiple Git repositories"
git push origin main
```

### 2. Unified CI Workflow

The CI workflow (`.github/workflows/ci.yml`) handles everything:

**Phase 1: Testing**
- **Lint checks** - `make lint` with golangci-lint
- **Unit tests** - `make test` with >90% coverage requirement
- **E2E tests** - `make test-e2e` with Kind cluster

**Phase 2: Release (only on main branch)**
- Uses GitHub Actions job dependencies (`needs: [build, e2e-test]`)
- Release jobs only run if all tests pass
- No external wait actions needed

### 3. Release Please Analysis

If tests pass and we're on main branch, release-please runs:

- Analyzes commits since last release
- Determines version bump based on conventional commit types

### 4. Release PR Creation

If version bump is needed, release-please:

- Creates or updates a Release PR
- Includes auto-generated CHANGELOG
- Updates version in:
  - `.release-please-manifest.json`
  - `charts/gitops-reverser/Chart.yaml` (both `version` and `appVersion`)

**Example Release PR:**

```markdown
# Release v0.2.0

## Features
* feat(controller): add support for multiple Git repositories

## Bug Fixes  
* fix(webhook): resolve race condition in event queue

## Documentation
* docs: update README with new configuration options

---
This PR was generated by release-please.
Merge this PR to create a GitHub Release.
```

### 5. Release PR Review & Merge

A maintainer reviews the Release PR:

- Verify the changelog is accurate
- Confirm version bump is appropriate
- Check that all changes are included

Once merged, the workflow automatically:

1. Creates a GitHub Release with the tag (e.g., `v0.2.0`)
2. Builds Docker images for `linux/amd64` and `linux/arm64`
3. Pushes images to `ghcr.io/configbutler/gitops-reverser`
4. Tags images with:
   - Specific version: `v0.2.0`
   - Major.minor: `v0.2`
   - Major: `v0`
   - Latest: `latest`

## Conventional Commit Format

### Structure

```
<type>(<optional scope>): <description>

[optional body]

[optional footer(s)]
```

### Commit Types and Version Bumps

| Type | Description | Version Bump | Example |
|------|-------------|--------------|---------|
| `feat` | New feature | **Minor** (0.1.0 → 0.2.0) | `feat(controller): add Git auth` |
| `fix` | Bug fix | **Patch** (0.1.0 → 0.1.1) | `fix(webhook): handle timeout` |
| `feat!` or `BREAKING CHANGE:` | Breaking change | **Major** (0.1.0 → 1.0.0) | `feat!: redesign API` |
| `docs` | Documentation | No bump | `docs: update README` |
| `style` | Code style | No bump | `style: format code` |
| `refactor` | Code refactor | No bump | `refactor: simplify logic` |
| `perf` | Performance | **Patch** (0.1.0 → 0.1.1) | `perf: optimize loop` |
| `test` | Tests | No bump | `test: add unit tests` |
| `build` | Build system | No bump | `build: update deps` |
| `ci` | CI changes | No bump | `ci: add coverage report` |
| `chore` | Other changes | No bump | `chore: update .gitignore` |
| `revert` | Revert commit | **Patch** (0.1.0 → 0.1.1) | `revert: undo feature X` |

### Examples

**Feature (Minor Bump):**
```bash
git commit -m "feat(controller): add support for multi-repository configurations

This allows users to configure different Git repositories for different 
namespaces, improving flexibility in audit trail organization.

Closes #42"
```

**Bug Fix (Patch Bump):**
```bash
git commit -m "fix(webhook): prevent race condition in event queue

The event queue could process events out of order when multiple 
webhooks fired simultaneously. This fix adds proper locking.

Fixes #123"
```

**Breaking Change (Major Bump):**
```bash
git commit -m "feat!: redesign GitRepoConfig API structure

BREAKING CHANGE: The GitRepoConfig CRD now uses a different schema.
Users must migrate existing resources using the provided migration script.

Migration guide: docs/migration-v1.md"
```

**Documentation (No Bump):**
```bash
git commit -m "docs: add Helm installation instructions to README"
```

## Files Modified by Release Process

### Automatically Updated

These files are updated automatically by release-please:

- `.release-please-manifest.json` - Tracks current version
- `charts/gitops-reverser/Chart.yaml` - Helm chart version and appVersion
- `CHANGELOG.md` - Auto-generated changelog (created on first release)

### Configuration Files

These files configure the release process (do not modify without understanding):

- `release-please-config.json` - Release-please configuration
- `.github/workflows/ci.yml` - Unified CI and release workflow

## Troubleshooting

### Release PR Not Created

**Problem:** Pushed to main but no Release PR was created.

**Possible Causes:**
1. **CI tests failed** - Check GitHub Actions for test failures
2. **No conventional commits** - Ensure commits follow `type: description` format
3. **No version bump needed** - Commits like `docs:` or `chore:` don't trigger releases

**Solution:**
```bash
# Check CI status
gh run list --branch main --limit 5

# View recent commits
git log --oneline -5

# Re-push with conventional commit
git commit --amend -m "feat: add new feature"
git push --force origin main
```

### Release PR Shows Wrong Version

**Problem:** Release PR version doesn't match expected bump.

**Possible Causes:**
1. **Multiple commit types** - Most significant type determines bump
2. **Breaking changes** - `!` or `BREAKING CHANGE:` triggers major bump
3. **Manifest out of sync** - `.release-please-manifest.json` has wrong version

**Solution:**
- Edit the Release PR to adjust version if needed
- Or close the PR, fix commits, and trigger again

### Docker Build Failed

**Problem:** Release was created but Docker images weren't published.

**Possible Causes:**
1. **Docker build errors** - Check build logs in Actions
2. **Platform build issues** - Multi-arch builds can fail on specific platforms
3. **Registry authentication** - GITHUB_TOKEN may have insufficient permissions

**Solution:**
```bash
# Check workflow logs
gh run view --log

# Manually trigger build
gh workflow run release.yml
```

### Release PR Created But CI Tests Failing

**Problem:** Release PR exists but CI shows as failing.

**Why This Happens:**
The release workflow waits for CI to pass before creating the PR, but if tests were flaky or succeeded intermittently, a PR might be created. When you try to merge, CI runs again and fails.

**Solution:**
1. Fix the failing tests in a new commit
2. Push to main
3. The Release PR will automatically update with the fix
4. Wait for CI to pass, then merge

## Best Practices

### 1. Write Clear Commit Messages

✅ Good:
```
feat(controller): add support for custom branch names

Users can now specify different branch names for different GitRepoConfigs,
allowing more flexible repository organization.
```

❌ Bad:
```
add stuff
fix bug
wip
```

### 2. Scope Your Commits

Use scopes to indicate which component is affected:
- `feat(controller): ...`
- `fix(webhook): ...`
- `docs(readme): ...`
- `test(integration): ...`

### 3. One Concern Per Commit

Break large changes into focused commits:
```bash
git commit -m "feat(controller): add multi-repo support"
git commit -m "docs: document multi-repo configuration"
git commit -m "test: add multi-repo integration tests"
```

### 4. Review Release PRs Carefully

Before merging a Release PR:
- ✅ Verify changelog accuracy
- ✅ Check version bump is appropriate
- ✅ Ensure all relevant commits are included
- ✅ Confirm breaking changes are documented

### 5. Coordinate Breaking Changes

For major version bumps:
1. Discuss in an issue first
2. Add migration guide to `docs/`
3. Update CONTRIBUTING.md if process changes
4. Announce in discussions/Slack

## Manual Release (Emergency)

If automated releases fail, you can create a manual release:

```bash
# 1. Tag the commit
git tag -a v0.2.1 -m "Release v0.2.1"
git push origin v0.2.1

# 2. The CI workflow will build and push Docker images

# 3. Create GitHub Release manually
gh release create v0.2.1 \
  --title "v0.2.1" \
  --notes "Emergency release: fix critical bug"
```

**Note:** Manual releases should be rare. Fix the automation instead.

## Further Reading

- [Conventional Commits Specification](https://www.conventionalcommits.org/)
- [Semantic Versioning](https://semver.org/)
- [Release Please Documentation](https://github.com/googleapis/release-please)
- [GitHub Actions Workflows](https://docs.github.com/en/actions)

## Questions?

If you have questions about the release process:
1. Check this document first
2. Review existing Release PRs for examples
3. Open a discussion in GitHub Discussions
4. Contact a maintainer