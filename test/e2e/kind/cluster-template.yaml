# kind cluster configuration template with audit webhook support
# This template uses ${HOST_PROJECT_PATH} which gets replaced at runtime
# with the actual host path by the start-cluster.sh script
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  # Bind the API server on all host interfaces so devcontainer clients can
  # reach it via host.docker.internal.
  apiServerAddress: "0.0.0.0"
nodes:
- role: control-plane
  # Mount the entire audit directory using $PROJECT_PATH path for Docker-in-Docker (or $HOST_PROJECT_PATH if you use mount to the docker socket)
  extraMounts:
  - hostPath: ${HOST_PROJECT_PATH}/test/e2e/kind/audit
    containerPath: /etc/kubernetes/audit
    readOnly: false

  # Configure kube-apiserver with audit webhook
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        audit-policy-file: /etc/kubernetes/audit/policy.yaml
        audit-webhook-config-file: /etc/kubernetes/audit/webhook-config.yaml
        audit-webhook-batch-max-wait: "1s"
        audit-webhook-batch-max-size: "10"
      extraVolumes:
      - name: audit-config
        hostPath: /etc/kubernetes/audit
        mountPath: /etc/kubernetes/audit
        readOnly: true
        pathType: DirectoryOrCreate
