apiVersion: audit.k8s.io/v1
kind: Policy
omitStages:
  - "RequestReceived"
rules:
  # -----------------------------------------------------------
  # 1. NOISE & SECURITY FILTER (Level: None)
  # -----------------------------------------------------------
  - level: None
    resources:
    # CORE: Drop runtime noise
    - group: ""
      resources: ["events", "endpoints", "nodes", "pods", "secrets", "bindings", "componentstatuses", "*/status"]

    # AUTH: Drop ephemeral checks
    - group: "authentication.k8s.io"
      resources: ["tokenreviews"]
    - group: "authorization.k8s.io"
      resources: ["subjectaccessreviews", "selfsubjectaccessreviews", "localsubjectaccessreviews", "selfsubjectrulesreviews"]

    # SYSTEM: Drop heartbeats
    - group: "coordination.k8s.io"
      resources: ["leases"]

    # APPS: Drop status updates for Deployments, StatefulSets, DaemonSets
    - group: "apps"
      resources: ["*/status"]
    
    # NETWORKING: Drop status updates for Ingresses (Load Balancer IP updates)
    - group: "networking.k8s.io"
      resources: ["*/status"]

  # -----------------------------------------------------------
  # 2. HPA NOISE FILTER (Level: None)
  # -----------------------------------------------------------
  - level: None
    users: ["system:serviceaccount:kube-system:horizontal-pod-autoscaler"]
    verbs: ["update", "patch"]
    resources:
    - group: "apps" # Deployments & StatefulSets live here
      resources: ["*/scale"]

  # -----------------------------------------------------------
  # 3. INTENT CAPTURE (Level: RequestResponse)
  # -----------------------------------------------------------
  - level: RequestResponse
    omitManagedFields: true
    verbs:
    - create
    - update
    - patch
    - delete
    - deletecollection
    # No resources listed = Matches everything else (including CRDs)
