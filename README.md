# GitOps Reverser

**Reverse the flow: Cluster → Git**

GitOps Reverser is a Kubernetes operator that captures manual cluster changes and automatically commits them to Git, creating a complete audit trail and enabling new operational patterns beyond traditional GitOps.

## Overview

Traditional GitOps flows from Git → Cluster(s). This tool reverses that flow: **Cluster → Git**.

When administrators make manual changes to your Kubernetes cluster (hotfixes, emergency patches, configuration tweaks), GitOps Reverser automatically:
- Captures those changes in real-time via admission webhooks
- Sanitizes and formats them as YAML manifests
- Commits them to your Git repository with detailed metadata
- Handles race conditions and conflicts intelligently

This creates a perfect audit trail and enables new operational patterns while maintaining the benefits of Git-based infrastructure management.

## Philosophy and Best Practices

### Source of Truth: Understanding the Flow

**The cluster's live state is the immediate source of truth for events.** The tool's purpose is to ensure that Git—which should be the long-term, auditable source of truth—accurately reflects that reality.

#### Conflict Resolution: "Last Writer Wins"

Our "Re-evaluate and Re-generate" strategy handles conflicts predictably:

- **If a human pushes to Git, then an admin makes a newer change on the cluster**: The tool will successfully push the cluster change to Git, overwriting the human's older change. *Cluster wins.*

- **If the tool tries to push a cluster change, but a human has pushed a newer change to Git**: The tool will back off, discard its stale event, and accept the human's change as truth. *Git wins.*

This "last write wins" approach avoids messy merge conflicts and respects the most recent intent, regardless of origin.

### ⚠️ Critical: Avoiding Infinite Loops

**You should NOT run a traditional GitOps tool (like Argo CD/Flux) and GitOps Reverser on the same resources in fully automated mode.**

This would create an infinite loop:
1. GitOps Reverser sees a manual change and pushes it to Git
2. Argo CD sees Git changed and "corrects" the cluster
3. GitOps Reverser sees the "correction" as a new change
4. The cycle repeats endlessly

## Usage Patterns

GitOps Reverser is designed for teams operating in these modes:

### 1. **Audit-Only Mode**
Simply maintain a perfect Git-based audit trail of all manual changes without automated enforcement.

### 2. **Human-in-the-Loop Mode**
- Allow manual hotfixes during incidents
- Capture them immediately in Git
- Have humans review commits and decide whether to formalize or revert

### 3. **Drift Detection Mode**
Use commits generated by this tool as input for alerting systems that warn when clusters have been changed manually.

### 4. **Hybrid GitOps**
Run traditional GitOps on some resources (infrastructure, base applications) while using GitOps Reverser on others (configurations, secrets, operational tweaks).

## Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Kubernetes    │    │  GitOps Reverser │    │   Git Repository│
│     Cluster     │───▶│    Operator      │───▶│                 │
│                 │    │                  │    │  audit-trail/   │
│ Manual Changes  │    │ • Webhooks       │    │  ├─ namespaces/ │
│ Admin Actions   │    │ • Sanitization   │    │  ├─ cluster/    │
│ Hotfixes        │    │ • Race Handling  │    │  └─ commits...  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Key Components

- **Admission Webhooks**: Capture changes in real-time
- **Event Queue**: Buffer and batch changes for efficient processing
- **Git Worker**: Handle repository operations with conflict resolution
- **Sanitization Engine**: Clean and format Kubernetes manifests
- **Rule Engine**: Configure which resources to track and how

## Getting Started

### Prerequisites
- kubectl v1.11.3+
- Access to a Kubernetes v1.11.3+ cluster
- Git repository for storing captured changes
- cert-manager 1.13+ (for webhook TLS certificates)

### Installation

#### Option 1: Single YAML File (Quickest)

Install everything in one command:

```bash
kubectl apply -f https://github.com/ConfigButler/gitops-reverser/releases/latest/download/install.yaml
```

This installs:
- Custom Resource Definitions (CRDs)
- Controller deployment with 2 replicas (HA)
- RBAC roles and service accounts
- Webhooks and certificates
- Metrics service

#### Option 2: Helm Chart (Recommended for Production)

```bash
# Install cert-manager (if not already installed)
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.16.2/cert-manager.yaml

# Install GitOps Reverser
helm install gitops-reverser \
  oci://ghcr.io/configbutler/charts/gitops-reverser \
  --namespace gitops-reverser-system \
  --create-namespace
```

For production configuration options, see the [Helm Chart README](charts/gitops-reverser/README.md).

### Quick Start

> 📖 **Complete Setup Guide:** See [`docs/GITHUB_SETUP_GUIDE.md`](docs/GITHUB_SETUP_GUIDE.md) for detailed GitHub configuration with copy/paste commands.

1. **Configure your Git repository:**
   ```bash
   # Generate SSH key for authentication
   ssh-keygen -t ed25519 -C "gitops-reverser" -f ~/.ssh/gitops-reverser/id_ed25519 -N ""
   
   # Add the public key as a GitHub deploy key (with write access)
   cat ~/.ssh/gitops-reverser/id_ed25519.pub
   
   # Create Kubernetes secret
   ssh-keyscan github.com > /tmp/known_hosts
   kubectl create secret generic git-credentials \
     --namespace gitops-reverser-system \
     --from-file=ssh-privatekey=$HOME/.ssh/gitops-reverser/id_ed25519 \
     --from-file=known_hosts=/tmp/known_hosts
   ```

2. **Create a GitRepoConfig:**
   ```yaml
   apiVersion: configbutler.ai/v1alpha1
   kind: GitRepoConfig
   metadata:
     name: audit-repo
     namespace: gitops-reverser-system
   spec:
     url: "git@github.com:yourorg/k8s-audit.git"
     branch: "main"
     secretRef:
       name: git-credentials
   ```

3. **Create WatchRules to define what to capture:**
   ```yaml
   apiVersion: configbutler.ai/v1alpha1
   kind: WatchRule
   metadata:
     name: capture-configmaps
     namespace: gitops-reverser-system
   spec:
     gitRepoConfigRef: audit-repo
     rules:
       - resources: ["configmaps"]
     excludeLabels:
       matchLabels:
         "gitops-reverser/ignore": "true"
   ```

4. **Apply the configurations:**
   ```bash
   kubectl apply -f gitrepoconfig.yaml
   kubectl apply -f watchrule.yaml
   ```

### Configuration Examples

#### Capture All Resource Types
```yaml
apiVersion: configbutler.ai/v1alpha1
kind: WatchRule
metadata:
  name: capture-all
  namespace: gitops-reverser-system
spec:
  gitRepoConfigRef: audit-repo
  rules:
    - resources: ["*"]
  excludeLabels:
    matchLabels:
      "gitops-reverser/ignore": "true"
```

#### Capture Only Secrets and ConfigMaps
```yaml
apiVersion: configbutler.ai/v1alpha1
kind: WatchRule
metadata:
  name: config-audit
  namespace: gitops-reverser-system
spec:
  gitRepoConfigRef: audit-repo
  rules:
    - resources: ["secrets", "configmaps"]
  excludeLabels:
    matchExpressions:
      - key: "gitops-reverser/ignore"
        operator: Exists
```

## Repository Structure

Captured changes are organized in your Git repository as:

```
audit-trail/
├── namespaces/
│   ├── production/
│   │   ├── ConfigMap/
│   │   │   ├── app-config.yaml
│   │   │   └── database-config.yaml
│   │   └── Secret/
│   │       └── api-keys.yaml
│   └── staging/
│       └── ...
└── cluster-scoped/
    ├── ClusterRole/
    │   └── admin-role.yaml
    └── Namespace/
        └── new-namespace.yaml
```

Each commit includes detailed metadata:
```
[CREATE] ConfigMap/app-config in ns/production by user/admin@company.com

- Resource: ConfigMap/app-config
- Namespace: production  
- Operation: CREATE
- User: admin@company.com
- Timestamp: 2025-01-31T18:30:00Z
- Resource Version: 12345
```

## Testing

The project includes comprehensive tests:

- **Unit Tests**: 30+ tests covering core functionality
- **Integration Tests**: Git operations and race condition handling
- **Controller Tests**: Kubernetes controller behavior
- **E2E Tests**: Full workflow validation with Prometheus-based metrics

### Running Tests

```bash
# Unit tests (recommended for development)
make test

# E2E tests (requires Docker and Kind)
make test-e2e

# All tests with coverage
go test $(go list ./... | grep -v /e2e) -coverprofile=coverage.out
```

### E2E Test Infrastructure

E2E tests use persistent infrastructure for debugging:

**Setup infrastructure (one-time):**
```bash
make e2e-setup  # Deploys Gitea + Prometheus + starts port-forwards
```

**Run tests:**
```bash
make test-e2e  # Automatically starts port-forwards if needed
```

**Access services (for debugging):**
```bash
# Start port-forwards in background
make setup-port-forwards

# Access from your browser:
# - Gitea UI: http://localhost:3000 (user: testorg, pass: gitea)
# - Prometheus UI: http://localhost:9090

# Stop port-forwards:
make cleanup-port-forwards
```

**Cleanup:**
```bash
make e2e-cleanup  # Remove all e2e infrastructure
```

### E2E Debugging Features

The e2e tests now use **Prometheus for metrics validation**, enabling:

- ✅ **Multi-pod metric aggregation** - Test HA configurations with 2 controller replicas
- ✅ **Leader election validation** - Verify only leader pod processes webhook events
- ✅ **Post-test inspection** - Metrics persist after tests for debugging
- ✅ **Clean PromQL queries** - Readable assertions like `sum(gitopsreverser_events_received_total{role="leader"})`

See [`test/e2e/E2E_DEBUGGING.md`](test/e2e/E2E_DEBUGGING.md) for detailed debugging guide.

See [TESTING.md](TESTING.md) for detailed testing information.

## Monitoring and Observability

GitOps Reverser exports OpenTelemetry metrics:

- `gitops_reverser_events_received_total`: Total webhook events received
- `gitops_reverser_events_processed_total`: Total events successfully processed  
- `gitops_reverser_git_operations_total`: Git operations (push, commit, etc.)
- `gitops_reverser_git_push_duration_seconds`: Time taken for Git pushes
- `gitops_reverser_git_commit_queue_size`: Current event queue size

## Security Considerations

- **Git Credentials**: Store SSH keys securely using Kubernetes secrets
- **RBAC**: The operator requires cluster-wide read access and webhook configuration
- **Sanitization**: Sensitive data is automatically sanitized before Git commits
- **Audit Trail**: All operations are logged with user attribution

### A Note on TLS Certificates

When you install the gitops-reverser, you will see that it creates TLS certificates and a secure webhook endpoint. This is not optional; it is a fundamental security requirement from Kubernetes itself. To ensure that no malicious actor can intercept or impersonate communication between the Kubernetes API server and our webhook, all traffic must be encrypted over HTTPS. Our Helm chart handles this certificate management for you automatically.
## Troubleshooting

### Common Issues

1. **Git Authentication Failures**
   ```bash
   # Verify SSH key format and permissions
   kubectl logs -n sut deployment/gitops-reverser-controller
   ```

2. **Webhook Not Triggering**
   ```bash
   # Check webhook configuration
   kubectl get validatingwebhookconfiguration
   kubectl get mutatingwebhookconfiguration
   ```

3. **Race Condition Errors**
   ```bash
   # These are normal and handled automatically
   # Check metrics for success rates
   ```

## Contributing

We welcome contributions! Please see our [Contributing Guide](CONTRIBUTING.md) for details.

### Development Setup

1. Clone the repository
2. Run `make test` to verify your environment
3. Make changes and add tests
4. Run `make lint` to check code quality
5. Submit a pull request

## Automated Releases

GitOps Reverser uses automated semantic versioning based on [Conventional Commits](https://www.conventionalcommits.org/). Every push to `main` automatically creates releases when appropriate, all handled by a single unified CI workflow.

> **Setup & Usage Guide:** See [`.github/RELEASES.md`](.github/RELEASES.md) for complete documentation.

### Release Workflow

```
┌─────────────────┐
│ Push to main    │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────┐
│   CI Workflow (.github/workflows/ci.yml)   │
├─────────────────────────────────┤
│                                 │
│  ┌──────────────┐  ┌──────────┐│
│  │ Build & Test │  │ E2E Test ││
│  │ • lint       │  │ • Kind   ││
│  │ • unit tests │  │ • e2e    ││
│  │ • build      │  │          ││
│  └──────┬───────┘  └─────┬────┘│
│         │                │     │
│         └────────┬───────┘     │
│                  ▼             │
│         ┌────────────────┐     │
│         │ Tests Passed?  │     │
│         └────────┬───────┘     │
│                  │             │
│         ┌────────┴────────┐    │
│        No               Yes   │
│         │                 │    │
│         ▼                 ▼    │
│    ┌────────┐    ┌─────────────┐
│    │  Stop  │    │release-please│
│    └────────┘    │ analyzes    │
│                  │ commits     │
│                  └──────┬──────┘
│                         │       │
│                    ┌────┴────┐  │
│                   Version    │  │
│                   bump?      │  │
│                    └────┬────┘  │
│                         │       │
│                    ┌────┴────┐  │
│                   Yes      No  │
│                    │        │   │
│                    ▼        ▼   │
│           ┌────────────┐  End  │
│           │Create/Update│       │
│           │ Release PR │       │
│           └──────┬─────┘       │
└──────────────────┼─────────────┘
                   │
                   ▼
            ┌──────────┐
            │Human     │
            │Reviews PR│
            └─────┬────┘
                  │
            ┌─────┴─────┐
           No          Yes
            │            │
            ▼            ▼
          End    ┌──────────────┐
                 │ Merge PR     │
                 └──────┬───────┘
                        │
                        ▼
                ┌───────────────┐
                │Create Release │
                │+ Tag (v0.2.0) │
                └───────┬───────┘
                        │
                        ▼
                ┌───────────────┐
                │ Build & Push  │
                │Docker Images  │
                │(amd64, arm64) │
                └───────────────┘
```

### Commit Message Format

Use conventional commit format to trigger automated releases:

- `feat:` - New feature (minor version bump: 0.1.0 → 0.2.0)
- `fix:` - Bug fix (patch version bump: 0.1.0 → 0.1.1)
- `feat!:` or `BREAKING CHANGE:` - Breaking change (major version bump: 0.1.0 → 1.0.0)

**Examples:**
```bash
# Minor version bump
git commit -m "feat(controller): add multi-repository support"

# Patch version bump
git commit -m "fix(webhook): resolve race condition in event queue"

# Major version bump
git commit -m "feat!: redesign API structure

BREAKING CHANGE: API now uses different authentication method"
```

See [`CONTRIBUTING.md`](CONTRIBUTING.md) for complete commit message guidelines.

### Release Process

1. **Developer pushes to main** with conventional commit
2. **CI tests run automatically** (lint, unit tests, e2e)
3. **If tests pass:** release-please creates/updates Release PR
4. **Release PR includes:**
   - Auto-generated changelog
   - Version bump in `Chart.yaml`
   - List of commits since last release
5. **When Release PR is merged:**
   - GitHub Release created with tag
   - Docker images built for multiple platforms
   - Images pushed to ghcr.io
   - Release notes published

### Testing Gate

**Important:** Release PRs are only created if all CI tests pass. This ensures:
- ✅ All code is linted and formatted correctly
- ✅ Unit tests achieve >90% coverage
- ✅ End-to-end tests validate full workflows
- ✅ No broken code reaches production

## Roadmap

- [ ] Support for custom Git commit message templates
- [ ] Only write Secrets after they are encrypted (not sure yet which technology: SealedSecrets, SOPS or something else?)
- [ ] Integration with popular GitOps tools (Argo CD, Flux)
- [ ] Advanced filtering and transformation rules
- [ ] Multi-repository support
- [ ] Webhook payload signing and verification

## License

Copyright 2025 ConfigButler.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

---

**Questions? Issues? Ideas?**

- 📖 [Documentation](https://github.com/ConfigButler/gitops-reverser/wiki)
- 🐛 [Report Issues](https://github.com/ConfigButler/gitops-reverser/issues)
- 💬 [Discussions](https://github.com/ConfigButler/gitops-reverser/discussions)
- 🔒 [Security Policy](SECURITY.md)
