# GitOps Reverser

**Reverse the flow: Cluster → Git**

GitOps Reverser is a Kubernetes operator that captures manual cluster changes and automatically commits them to Git, creating a complete audit trail and enabling new operational patterns beyond traditional GitOps.

## Overview

Traditional GitOps flows from Git → Cluster. This tool reverses that flow: **Cluster → Git**.

When administrators make manual changes to your Kubernetes cluster (hotfixes, emergency patches, configuration tweaks), GitOps Reverser automatically:
- Captures those changes in real-time via admission webhooks
- Sanitizes and formats them as YAML manifests
- Commits them to your Git repository with detailed metadata
- Handles race conditions and conflicts intelligently

This creates a perfect audit trail and enables new operational patterns while maintaining the benefits of Git-based infrastructure management.

## Philosophy and Best Practices

### Source of Truth: Understanding the Flow

**The cluster's live state is the immediate source of truth for events.** The tool's purpose is to ensure that Git—which should be the long-term, auditable source of truth—accurately reflects that reality.

#### Conflict Resolution: "Last Writer Wins"

Our "Re-evaluate and Re-generate" strategy handles conflicts predictably:

- **If a human pushes to Git, then an admin makes a newer change on the cluster**: The tool will successfully push the cluster change to Git, overwriting the human's older change. *Cluster wins.*

- **If the tool tries to push a cluster change, but a human has pushed a newer change to Git**: The tool will back off, discard its stale event, and accept the human's change as truth. *Git wins.*

This "last write wins" approach avoids messy merge conflicts and respects the most recent intent, regardless of origin.

### ⚠️ Critical: Avoiding Infinite Loops

**You should NOT run a traditional GitOps tool (like Argo CD/Flux) and GitOps Reverser on the same resources in fully automated mode.**

This would create an infinite loop:
1. GitOps Reverser sees a manual change and pushes it to Git
2. Argo CD sees Git changed and "corrects" the cluster
3. GitOps Reverser sees the "correction" as a new change
4. The cycle repeats endlessly

## Usage Patterns

GitOps Reverser is designed for teams operating in these modes:

### 1. **Audit-Only Mode**
Simply maintain a perfect Git-based audit trail of all manual changes without automated enforcement.

### 2. **Human-in-the-Loop Mode**
- Allow manual hotfixes during incidents
- Capture them immediately in Git
- Have humans review commits and decide whether to formalize or revert

### 3. **Drift Detection Mode**
Use commits generated by this tool as input for alerting systems that warn when clusters have been changed manually.

### 4. **Hybrid GitOps**
Run traditional GitOps on some resources (infrastructure, base applications) while using GitOps Reverser on others (configurations, secrets, operational tweaks).

## Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Kubernetes    │    │  GitOps Reverser │    │   Git Repository│
│     Cluster     │───▶│    Operator      │───▶│                 │
│                 │    │                  │    │  audit-trail/   │
│ Manual Changes  │    │ • Webhooks       │    │  ├─ namespaces/ │
│ Admin Actions   │    │ • Sanitization   │    │  ├─ cluster/    │
│ Hotfixes        │    │ • Race Handling  │    │  └─ commits...  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Key Components

- **Admission Webhooks**: Capture changes in real-time
- **Event Queue**: Buffer and batch changes for efficient processing
- **Git Worker**: Handle repository operations with conflict resolution
- **Sanitization Engine**: Clean and format Kubernetes manifests
- **Rule Engine**: Configure which resources to track and how

## Getting Started

### Prerequisites
- Go 1.24.0+
- Docker 17.03+
- kubectl v1.11.3+
- Access to a Kubernetes v1.11.3+ cluster
- Git repository for storing captured changes

### Quick Start

1. **Install the CRDs:**
   ```bash
   make install
   ```

2. **Configure your Git repository:**
   ```bash
   kubectl create secret generic git-credentials \
     --from-file=ssh-key=/path/to/your/ssh-key \
     --from-literal=known-hosts="$(ssh-keyscan github.com)"
   ```

3. **Create a GitRepoConfig:**
   ```yaml
   apiVersion: configbutler.ai/v1alpha1
   kind: GitRepoConfig
   metadata:
     name: audit-repo
   spec:
     url: "git@github.com:yourorg/k8s-audit.git"
     branch: "main"
     secretRef:
       name: git-credentials
   ```

4. **Create WatchRules to define what to capture:**
   ```yaml
   apiVersion: configbutler.ai/v1alpha1
   kind: WatchRule
   metadata:
     name: capture-configmaps
   spec:
     gitRepoConfigRef: audit-repo
     resources:
     - apiVersion: "v1"
       kind: "ConfigMap"
     namespaceSelector:
       matchLabels:
         audit: "enabled"
   ```

5. **Deploy the operator:**
   ```bash
   make deploy IMG=ghcr.io/configbutler/gitops-reverser:latest
   ```

### Configuration Examples

#### Capture All Changes in Production Namespaces
```yaml
apiVersion: configbutler.ai/v1alpha1
kind: WatchRule
metadata:
  name: production-audit
spec:
  gitRepoConfigRef: audit-repo
  resources:
  - apiVersion: "*"
    kind: "*"
  namespaceSelector:
    matchLabels:
      environment: "production"
  excludeLabels:
    matchLabels:
      "gitops-reverser/ignore": "true"
```

#### Capture Only Secrets and ConfigMaps
```yaml
apiVersion: configbutler.ai/v1alpha1
kind: WatchRule
metadata:
  name: config-audit
spec:
  gitRepoConfigRef: audit-repo
  resources:
  - apiVersion: "v1"
    kind: "Secret"
  - apiVersion: "v1"
    kind: "ConfigMap"
```

## Repository Structure

Captured changes are organized in your Git repository as:

```
audit-trail/
├── namespaces/
│   ├── production/
│   │   ├── ConfigMap/
│   │   │   ├── app-config.yaml
│   │   │   └── database-config.yaml
│   │   └── Secret/
│   │       └── api-keys.yaml
│   └── staging/
│       └── ...
└── cluster-scoped/
    ├── ClusterRole/
    │   └── admin-role.yaml
    └── Namespace/
        └── new-namespace.yaml
```

Each commit includes detailed metadata:
```
[CREATE] ConfigMap/app-config in ns/production by user/admin@company.com

- Resource: ConfigMap/app-config
- Namespace: production  
- Operation: CREATE
- User: admin@company.com
- Timestamp: 2025-01-31T18:30:00Z
- Resource Version: 12345
```

## Testing

The project includes comprehensive tests:

- **Unit Tests**: 30+ tests covering core functionality
- **Integration Tests**: Git operations and race condition handling  
- **Controller Tests**: Kubernetes controller behavior
- **E2E Tests**: Full workflow validation

Run tests locally:
```bash
# Unit tests (recommended for development)
make test

# E2E tests (requires Docker and Kind)
make test-e2e

# All tests with coverage
go test $(go list ./... | grep -v /e2e) -coverprofile=coverage.out
```

See [TESTING.md](TESTING.md) for detailed testing information.

## Monitoring and Observability

GitOps Reverser exports OpenTelemetry metrics:

- `gitops_reverser_events_received_total`: Total webhook events received
- `gitops_reverser_events_processed_total`: Total events successfully processed  
- `gitops_reverser_git_operations_total`: Git operations (push, commit, etc.)
- `gitops_reverser_git_push_duration_seconds`: Time taken for Git pushes
- `gitops_reverser_git_commit_queue_size`: Current event queue size

## Security Considerations

- **Git Credentials**: Store SSH keys securely using Kubernetes secrets
- **RBAC**: The operator requires cluster-wide read access and webhook configuration
- **Sanitization**: Sensitive data is automatically sanitized before Git commits
- **Audit Trail**: All operations are logged with user attribution

## Troubleshooting

### Common Issues

1. **Git Authentication Failures**
   ```bash
   # Verify SSH key format and permissions
   kubectl logs -n gitops-reverser-system deployment/gitops-reverser-controller
   ```

2. **Webhook Not Triggering**
   ```bash
   # Check webhook configuration
   kubectl get validatingwebhookconfiguration
   kubectl get mutatingwebhookconfiguration
   ```

3. **Race Condition Errors**
   ```bash
   # These are normal and handled automatically
   # Check metrics for success rates
   ```

## Contributing

We welcome contributions! Please see our [Contributing Guide](CONTRIBUTING.md) for details.

### Development Setup

1. Clone the repository
2. Run `make test` to verify your environment
3. Make changes and add tests
4. Run `make lint` to check code quality
5. Submit a pull request

## Roadmap

- [ ] Support for custom Git commit message templates
- [ ] Integration with popular GitOps tools (Argo CD, Flux)
- [ ] Advanced filtering and transformation rules
- [ ] Multi-repository support
- [ ] Webhook payload signing and verification

## License

Copyright 2025 ConfigButler.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

---

**Questions? Issues? Ideas?**

- 📖 [Documentation](https://github.com/ConfigButler/gitops-reverser/wiki)
- 🐛 [Report Issues](https://github.com/ConfigButler/gitops-reverser/issues)
- 💬 [Discussions](https://github.com/ConfigButler/gitops-reverser/discussions)
- 🔒 [Security Policy](SECURITY.md)
